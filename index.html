<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PÓDIUM PREMIUM v2.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #0b0f1a; color: #f8fafc; overflow-x: hidden; }
        .premium-card { background: rgba(22, 28, 45, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); border-radius: 1.5rem; }
        .btn-gold { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); color: #000; font-weight: 900; }
        .btn-logout { background-color: #ef4444; color: white; border-radius: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.7rem; font-weight: 900; }
        .podium-slot { border: 2px dashed #334155; border-radius: 1rem; min-height: 80px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .slot-filled { border: 2px solid #fbbf24; background: rgba(251, 191, 36, 0.05); }
        .hidden { display: none; }
        .loader { border: 4px solid rgba(255, 255, 255, 0.1); border-left-color: #fbbf24; border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .text-huge { font-size: 1.25rem; font-weight: 900; }
        .text-pozo { font-size: 1.1rem; color: #fbbf24; font-weight: 900; }
        .btn-modificar { background: #ef4444; color: white; font-size: 10px; padding: 8px 12px; border-radius: 8px; font-weight: 900; }
        .btn-stats { background: #3b82f6; color: white; font-size: 10px; padding: 8px 12px; border-radius: 8px; font-weight: 900; }
        .band-disabled { opacity: 0.2 !important; pointer-events: none !important; filter: grayscale(1); }
        
        /* BOTÓN RESULTADOS CONTEXTUAL */
        .btn-results-locked { background: rgba(51, 65, 85, 0.3); color: rgba(148, 163, 184, 0.4); border: 1px solid rgba(255,255,255,0.02); cursor: not-allowed; }
        .btn-results-active { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; font-weight: 900; box-shadow: 0 10px 20px rgba(59, 130, 246, 0.2); }
        
        .region-closed { opacity: 0.5; position: relative; }
        .region-closed::after { content: 'CERRADA'; position: absolute; top: 10px; right: 15px; font-size: 7px; background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 900; }
    </style>
</head>
<body class="p-4">

    <div id="loading-overlay" class="hidden fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p id="loader-text" class="text-[12px] font-black uppercase tracking-widest text-amber-500">PROCESANDO...</p>
    </div>

    <header id="global-header" class="hidden flex justify-between items-start mb-8">
        <div id="atras-container" class="w-16"><button id="btn-atras" class="text-[11px] font-black text-slate-500 uppercase tracking-widest pt-2">← ATRÁS</button></div>
        <div class="text-center flex-1 text-amber-500 font-black tracking-tighter uppercase">PÓDIUM PREMIUM v2.3<p id="header-username" class="text-[10px] text-slate-400 font-bold"></p></div>
        <div class="w-16 flex justify-end"><button onclick="logout()" class="btn-logout uppercase tracking-tighter">SALIR</button></div>
    </header>

    <!-- VISTA LOGIN -->
    <div id="view-login" class="max-w-md mx-auto mt-20">
        <h1 class="text-4xl font-black text-center mb-1 uppercase tracking-tighter">PÓDIUM <span class="text-amber-500">PREMIUM</span></h1>
        <p class="text-center text-[10px] font-black text-slate-600 mb-10 tracking-[0.3em]">VERSIÓN 2.3</p>
        <div class="premium-card p-10 shadow-2xl">
            <input id="login-user" type="text" placeholder="USUARIO" class="w-full p-5 mb-5 rounded-2xl bg-slate-900 border border-slate-800 text-lg font-bold uppercase outline-none focus:border-amber-500">
            <input id="login-pass" type="password" placeholder="CONTRASEÑA" class="w-full p-5 mb-8 rounded-2xl bg-slate-900 border border-slate-800 text-lg font-bold outline-none focus:border-amber-500">
            <button onclick="handleLogin()" class="w-full btn-gold py-5 rounded-2xl text-lg font-black uppercase shadow-lg active:scale-95 transition-transform">ENTRAR</button>
        </div>
    </div>

    <!-- VISTA REGIONES -->
    <div id="view-region" class="hidden max-w-md mx-auto">
        <h2 class="text-3xl font-black mb-10 text-center uppercase tracking-tight">SELECCIONA REGIÓN</h2>
        <div id="region-list" class="grid gap-4 mb-10"></div>
    </div>

    <!-- VISTA DASHBOARD -->
    <div id="view-dashboard" class="hidden max-w-md mx-auto pb-10">
        <p id="dash-region-tag" class="text-center text-amber-500 font-black uppercase mb-8 text-lg tracking-widest"></p>
        <div class="grid gap-4"> 
            <div class="premium-card p-6 border-amber-500/30"> 
                <p class="text-[11px] font-black text-slate-400 uppercase text-center mb-4 tracking-widest">POZO ESTIMADO</p>
                <div class="space-y-3">
                    <div class="flex justify-between items-center"><span class="font-bold text-sm uppercase">BÁSICO:</span><span id="pozo-basico-label" class="text-pozo">$0</span></div>
                    <div class="flex justify-between items-center"><span class="font-bold text-sm uppercase">MEDIO:</span><span id="pozo-medio-label" class="text-pozo">$0</span></div>
                    <div class="flex justify-between items-center"><span class="font-bold text-sm uppercase">ALTO:</span><span id="pozo-alto-label" class="text-pozo">$0</span></div>
                </div>
            </div>
            
            <div id="cont-basico" class="premium-card p-6 flex flex-col items-center"> 
                <button onclick="abrirNivel('Básico')" class="text-huge uppercase tracking-tighter">NIVEL BÁSICO</button>
                <div id="btns-basico" class="flex gap-3 mt-4 hidden">
                    <button onclick="confirmarModificar('Básico')" class="btn-modificar uppercase">MODIFICAR</button>
                    <button onclick="verEstadísticas('basico')" class="btn-stats uppercase">ESTADÍSTICAS</button>
                </div>
            </div>
            
            <div id="cont-medio" class="premium-card p-6 flex flex-col items-center">
                <button onclick="abrirNivel('Medio')" class="text-huge uppercase tracking-tighter">NIVEL MEDIO</button>
                <div id="btns-medio" class="flex gap-3 mt-4 hidden">
                    <button onclick="confirmarModificar('Medio')" class="btn-modificar uppercase">MODIFICAR</button>
                    <button onclick="verEstadísticas('medio')" class="btn-stats uppercase">ESTADÍSTICAS</button>
                </div>
            </div>
            
            <div id="cont-alto" class="premium-card p-6 flex flex-col items-center">
                <button onclick="abrirNivel('Alto')" class="text-huge uppercase tracking-tighter">NIVEL ALTO</button>
                <div id="btns-alto" class="flex gap-3 mt-4 hidden">
                    <button onclick="confirmarModificar('Alto')" class="btn-modificar uppercase">MODIFICAR</button>
                    <button onclick="verEstadísticas('alto')" class="btn-stats uppercase">ESTADÍSTICAS</button>
                </div>
            </div>

            <!-- BOTÓN RESULTADOS REGIÓN -->
            <div class="pt-4">
                <button onclick="abrirResultadosRegión()" id="btn-region-results" class="premium-card w-full p-5 font-black uppercase text-[12px] text-center transition-all">
                    VER RESULTADOS DE ESTA REGIÓN
                </button>
            </div>
        </div>
    </div>

    <!-- VISTA GANADORES -->
    <div id="view-resultados" class="hidden max-w-md mx-auto pb-10">
        <h2 class="text-2xl font-black mb-8 text-center uppercase tracking-tighter text-amber-500">GANADORES OFICIALES</h2>
        <div id="resultados-lista" class="space-y-6"></div>
    </div>

    <!-- PÓDIUM -->
    <div id="view-podium" class="hidden max-w-md mx-auto">
        <h2 id="podium-header" class="text-center text-2xl font-black uppercase text-amber-500 mb-8 tracking-tighter"></h2>
        <div id="podium-grid" class="grid grid-cols-3 gap-4 mb-8">
            <div onclick="removeBand(1)" id="slot-1" class="podium-slot flex-col p-2 text-center"><span class="text-[9px] font-black text-amber-500/50 block uppercase">1°</span><span id="txt-p1" class="text-[11px] font-black uppercase">VACÍO</span></div>
            <div onclick="removeBand(2)" id="slot-2" class="podium-slot flex-col p-2 text-center"><span class="text-[9px] font-black text-slate-500 block uppercase">2°</span><span id="txt-p2" class="text-[11px] font-black uppercase">VACÍO</span></div>
            <div onclick="removeBand(3)" id="slot-3" class="podium-slot flex-col p-2 text-center"><span class="text-[9px] font-black text-slate-500 block uppercase">3°</span><span id="txt-p3" class="text-[11px] font-black uppercase">VACÍO</span></div>
        </div>
        <div id="band-container" class="grid grid-cols-2 gap-3 max-h-[40vh] overflow-y-auto pb-24"></div>
        <div class="fixed bottom-0 left-0 w-full p-5 bg-slate-900/95 flex gap-4 backdrop-blur-md">
            <button onclick="cancelarPodium()" class="flex-1 border border-slate-700 py-5 rounded-2xl text-[12px] font-black uppercase">CANCELAR</button>
            <button onclick="prepararConfirmación()" class="flex-[2] btn-gold py-5 rounded-2xl text-[12px] font-black uppercase shadow-lg">CONFIRMAR</button>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal-confirm" class="hidden fixed inset-0 bg-black/95 flex items-center justify-center p-6 z-[110]">
        <div class="premium-card p-10 w-full max-w-sm text-center">
            <h3 id="modal-title" class="font-black mb-6 uppercase text-xl text-white"></h3>
            <p id="modal-text" class="text-[12px] text-slate-400 mb-10 uppercase font-bold whitespace-pre-line leading-relaxed"></p>
            <div id="modal-footer" class="flex gap-5">
                <button id="btn-modal-cancel" onclick="closeModal()" class="flex-1 text-[12px] font-black uppercase text-slate-500">NO</button>
                <button id="btn-modal-ok" class="flex-1 btn-gold py-4 rounded-xl text-[12px] font-black uppercase"></button>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbwlirIwKUL8oRuPNDyaRhgy371NQTyY9tWIcCs4a0gJEUNY3mNeURQQC4JTLaoQvWk/exec';
        
        const LIMITES_NIVEL = { 'basico': 2, 'medio': 2, 'alto': 3 };

        let user = localStorage.getItem('podium_user');
        let app = { region: '', nivel: '', p1: '', p2: '', p3: '', ediciones: 0, existe: false };
        let cacheData = {};
        let configGlobal = { config: {}, regiones: [], ganadoresOficiales: [] };

        if (user) initApp();

        function toggleLoader(s, text = "PROCESANDO...") { 
            document.getElementById('loader-text').innerText = text;
            document.getElementById('loading-overlay').classList.toggle('hidden', !s); 
        }

        async function initApp() {
            document.getElementById('header-username').innerText = user;
            document.getElementById('global-header').classList.remove('hidden');
            
            toggleLoader(true, "CARGANDO CONFIGURACIÓN...");
            try {
                const r = await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'getInitData' }) });
                configGlobal = await r.json();
            } catch(e) { console.error("Error initData:", e); }
            toggleLoader(false);

            const savedRegion = localStorage.getItem('podium_region');
            const savedNivel = localStorage.getItem('podium_nivel');
            if (savedRegion) {
                app.region = savedRegion;
                await cargarDatosRegión(savedRegion, false);
                if (savedNivel) abrirNivel(savedNivel);
                else showView('view-dashboard');
            } else {
                showView('view-region');
                renderRegiones();
            }
        }

        function renderRegiones() {
            const rs = ['NORTE', 'ORIENTE', 'CENTRO-SUR', 'OCCIDENTE PRÓSPERO', 'MAGDALENA CALDENSE', 'ALTO OCCIDENTE'];
            const c = document.getElementById('region-list'); c.innerHTML = '';
            rs.forEach(r => {
                const statusObj = configGlobal.regiones.find(reg => reg.nombre.toUpperCase() === r.toUpperCase());
                const isClosed = statusObj && statusObj.estado === 'CERRADA';
                
                const b = document.createElement('button');
                b.className = `premium-card p-6 font-black uppercase text-lg text-center active:scale-95 transition-transform ${isClosed ? 'region-closed' : ''}`;
                b.innerText = r; 
                b.onclick = () => {
                    if(isClosed) {
                        document.getElementById('modal-title').innerText = "REGIÓN CERRADA";
                        document.getElementById('modal-text').innerText = "Las apuestas para esta región han finalizado.\nNo se permiten nuevos registros ni ediciones.";
                        document.getElementById('btn-modal-ok').innerText = "ENTENDIDO";
                        document.getElementById('btn-modal-ok').onclick = closeModal;
                        document.getElementById('btn-modal-cancel').classList.add('hidden');
                        document.getElementById('modal-confirm').classList.remove('hidden');
                        return;
                    }
                    localStorage.setItem('podium_region', r);
                    cargarDatosRegión(r);
                };
                c.appendChild(b);
            });
        }

        async function cargarDatosRegión(region, changeView = true) {
            app.region = region;
            document.getElementById('dash-region-tag').innerText = region;
            
            const statusObj = configGlobal.regiones.find(reg => reg.nombre.toUpperCase() === region.toUpperCase());
            const btnResults = document.getElementById('btn-region-results');
            if (statusObj && statusObj.mostrarResultados) {
                btnResults.className = 'premium-card w-full p-5 font-black uppercase text-[12px] text-center btn-results-active transition-all';
                btnResults.innerHTML = 'VER RESULTADOS DE ESTA REGIÓN';
            } else {
                btnResults.className = 'premium-card w-full p-5 font-black uppercase text-[12px] text-center btn-results-locked transition-all';
                btnResults.innerHTML = 'RESULTADOS PRÓXIMAMENTE';
            }

            if(changeView) showView('view-dashboard');
            toggleLoader(true, "CARGANDO DATOS...");
            const niveles = ['basico', 'medio', 'alto'];
            try {
                const promesas = niveles.map(n => fetch(API, { method: 'POST', body: JSON.stringify({ action: 'getData', user, region, nivel: n }) }).then(r => r.json()));
                const resultados = await Promise.all(promesas);
                niveles.forEach((n, i) => {
                    const d = resultados[i]; cacheData[n] = d;
                    document.getElementById(`pozo-${n}-label`).innerText = `$${(d.config?.pozo || 0).toLocaleString()}`;
                    const btnBox = document.getElementById(`btns-${n}`);
                    if(d.miApuesta) btnBox.classList.remove('hidden'); else btnBox.classList.add('hidden');
                });
            } catch(e) { console.error(e); }
            toggleLoader(false);
        }

        function abrirResultadosRegión() {
            const statusObj = configGlobal.regiones.find(reg => reg.nombre.toUpperCase() === app.region.toUpperCase());
            if (!statusObj || !statusObj.mostrarResultados) {
                document.getElementById('modal-title').innerText = "PRÓXIMAMENTE";
                document.getElementById('modal-text').innerText = "Los resultados de esta región se publicarán al finalizar el concurso.";
                document.getElementById('btn-modal-ok').innerText = "ENTENDIDO";
                document.getElementById('btn-modal-ok').onclick = closeModal;
                document.getElementById('btn-modal-cancel').classList.add('hidden');
                document.getElementById('modal-confirm').classList.remove('hidden');
                return;
            }

            const lista = document.getElementById('resultados-lista');
            lista.innerHTML = '';
            const ganadoresReg = configGlobal.ganadoresOficiales.filter(g => g.region.toUpperCase() === app.region.toUpperCase());

            if (ganadoresReg.length === 0) {
                lista.innerHTML = '<div class="premium-card p-10 text-center"><p class="text-slate-400 font-bold uppercase text-[10px]">NO HAY GANADORES REGISTRADOS AÚN.</p></div>';
            } else {
                const container = document.createElement('div');
                container.className = 'premium-card p-6 border-amber-500/20 mb-4';
                let html = `<h4 class="text-amber-500 font-black uppercase text-sm mb-6 tracking-widest text-center border-b border-slate-800 pb-2">${app.region}</h4>`;
                ganadoresReg.forEach(gan => {
                    html += `
                        <div class="mb-6 last:mb-0">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-2">NIVEL ${gan.nivel}</p>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center text-[11px] font-bold uppercase"><span class="text-slate-500">1°</span> <span>${gan.p1}</span></div>
                                <div class="flex justify-between items-center text-[11px] font-bold uppercase"><span class="text-slate-500">2°</span> <span>${gan.p2}</span></div>
                                ${gan.p3 ? `<div class="flex justify-between items-center text-[11px] font-bold uppercase"><span class="text-slate-500">3°</span> <span>${gan.p3}</span></div>` : ''}
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
                lista.appendChild(container);
            }
            showView('view-resultados');
        }

        function showView(id) {
            document.querySelectorAll('div[id^="view-"]').forEach(v => v.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            const cont = document.getElementById('atras-container');
            if(id === 'view-region') cont.classList.add('invisible');
            else {
                cont.classList.remove('invisible');
                document.getElementById('btn-atras').onclick = () => {
                    if(id === 'view-dashboard') { localStorage.removeItem('podium_region'); showView('view-region'); } 
                    else if(id === 'view-podium') { cancelarPodium(); }
                    else if(id === 'view-resultados') { showView('view-dashboard'); }
                };
            }
        }

        function abrirNivel(nivelLabel) {
            app.nivel = nivelLabel;
            localStorage.setItem('podium_nivel', nivelLabel);
            const nNorm = nivelLabel.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const d = cacheData[nNorm];
            app.p1 = app.p2 = app.p3 = '';
            document.getElementById('podium-header').innerText = nivelLabel.toUpperCase();
            if(d.miApuesta) {
                app.p1 = d.miApuesta.p1; app.p2 = d.miApuesta.p2; app.p3 = d.miApuesta.p3;
                app.ediciones = d.miApuesta.ediciones; app.existe = true;
            } else { app.existe = false; app.ediciones = 0; }
            renderBandas(d.bandas, nNorm);
            syncUI();
            showView('view-podium');
        }

        function renderBandas(bandas, nNorm) {
            const c = document.getElementById('band-container'); c.innerHTML = '';
            const f = bandas.filter(b => b.region.trim().toLowerCase() === app.region.trim().toLowerCase() && b.nivel.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") === nNorm);
            f.forEach(b => {
                const bt = document.createElement('button');
                bt.className = 'premium-card p-5 text-[11px] font-black uppercase leading-tight btn-banda-item active:scale-95 transition-all';
                bt.innerText = b.nombre; 
                bt.onclick = () => {
                    const nNormActual = app.nivel.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const limite = LIMITES_NIVEL[nNormActual] || 3;
                    if(!app.p1) app.p1 = b.nombre; 
                    else if(!app.p2) app.p2 = b.nombre; 
                    else if(!app.p3 && limite === 3) app.p3 = b.nombre;
                    syncUI();
                }; 
                c.appendChild(bt);
            });
        }

        function syncUI() {
            const nNorm = app.nivel.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const limite = LIMITES_NIVEL[nNorm] || 3;
            document.getElementById('txt-p1').innerText = app.p1 || 'VACÍO';
            document.getElementById('txt-p2').innerText = app.p2 || 'VACÍO';
            document.getElementById('txt-p3').innerText = app.p3 || 'VACÍO';
            const podiumGrid = document.getElementById('podium-grid');
            if (limite === 2) {
                podiumGrid.classList.replace('grid-cols-3', 'grid-cols-2');
                document.getElementById('slot-3').classList.add('hidden');
                app.p3 = '';
            } else {
                podiumGrid.classList.replace('grid-cols-2', 'grid-cols-3');
                document.getElementById('slot-3').classList.remove('hidden');
            }
            const picks = [app.p1, app.p2, app.p3].filter(p => p !== '');
            document.querySelectorAll('.btn-banda-item').forEach(btn => {
                if(picks.includes(btn.innerText)) btn.classList.add('band-disabled');
                else btn.classList.remove('band-disabled');
            });
            for(let i=1; i<=3; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (slot) slot.className = `podium-slot flex-col p-2 text-center ${app['p'+i] ? 'slot-filled' : ''} ${i > limite ? 'hidden' : ''}`;
            }
        }

        function confirmarModificar(nivelLabel) {
            const nNorm = nivelLabel.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const d = cacheData[nNorm];
            const edicionesActuales = d.miApuesta ? d.miApuesta.ediciones : 0;
            const limiteEdiciones = configGlobal.config.limiteEdiciones || 3;
            
            if (edicionesActuales >= limiteEdiciones) {
                document.getElementById('modal-title').innerText = "SIN INTENTOS";
                document.getElementById('modal-text').innerText = "Ya has utilizado tus oportunidades de modificación.\n\nNo se permiten más cambios.";
                document.getElementById('btn-modal-ok').innerText = "ENTENDIDO";
                document.getElementById('btn-modal-ok').onclick = closeModal;
                document.getElementById('btn-modal-cancel').classList.add('hidden');
                document.getElementById('modal-confirm').classList.remove('hidden');
                return;
            }
            
            const costo = (configGlobal.config.costoEdicion || 1000).toLocaleString();
            document.getElementById('modal-title').innerText = "ATENCIÓN";
            document.getElementById('modal-text').innerText = `Vas a editar tu apuesta.\n\nIntento #${edicionesActuales + 1}.\nCosto: $${costo} que se descontará del pozo.`;
            document.getElementById('btn-modal-ok').innerText = "ENTENDIDO";
            document.getElementById('btn-modal-ok').onclick = () => { closeModal(); abrirNivel(nivelLabel); };
            document.getElementById('btn-modal-cancel').classList.remove('hidden');
            document.getElementById('modal-confirm').classList.remove('hidden');
        }

        function removeBand(s) { app['p'+s] = ''; syncUI(); }
        function cancelarPodium() { localStorage.removeItem('podium_nivel'); showView('view-dashboard'); }

        function prepararConfirmación() {
            const nNorm = app.nivel.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const limite = LIMITES_NIVEL[nNorm] || 3;
            const picks = [app.p1, app.p2, app.p3].filter(p => p !== '');
            if(picks.length < limite) return alert(`COMPLETA LAS ${limite} POSICIONES`);
            const uniquePicks = new Set(picks);
            if(uniquePicks.size !== limite) return alert('BANDA REPETIDA EN EL PÓDIUM');
            
            const costoE = (configGlobal.config.costoEntrada || 20000).toLocaleString();
            const costoEd = (configGlobal.config.costoEdicion || 1000).toLocaleString();
            const limiteEd = configGlobal.config.limiteEdiciones || 3;

            document.getElementById('modal-title').innerText = "¿CONFIRMAR?";
            document.getElementById('modal-text').innerText = app.existe ? `MODIFICAR COSTARÁ $${costoEd}.\nINTENTO: ${app.ediciones + 1} DE ${limiteEd}.` : `ESTA APUESTA TIENE UN VALOR DE $${costoE}.`;
            document.getElementById('btn-modal-ok').innerText = "SÍ, ENVIAR";
            document.getElementById('btn-modal-ok').onclick = execSave;
            document.getElementById('btn-modal-cancel').classList.remove('hidden');
            document.getElementById('modal-confirm').classList.remove('hidden');
        }

        async function execSave() {
            closeModal(); toggleLoader(true, "GUARDANDO...");
            try {
                const nNorm = app.nivel.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'saveApuesta', user, region: app.region, categoria: nNorm, p1: app.p1, p2: app.p2, p3: app.p3 }) });
                alert('¡ÉXITO!');
                localStorage.removeItem('podium_nivel');
                await cargarDatosRegión(app.region); 
            } catch(e) { alert('ERROR'); }
            toggleLoader(false);
        }

        async function handleLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            if(!u || !p) return;
            toggleLoader(true, "AUTENTICANDO...");
            try {
                const r = await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'login', user: u, pass: p }) });
                const d = await r.json();
                if(d.success) {
                    if(d.status === 'INACTIVO') {
                        document.getElementById('modal-title').innerText = "CUENTA INACTIVA";
                        document.getElementById('modal-text').innerText = "Tu usuario no se encuentra activo.\n\nComunícate con el administrador.";
                        document.getElementById('btn-modal-ok').innerText = "ENTENDIDO";
                        document.getElementById('btn-modal-ok').onclick = closeModal;
                        document.getElementById('btn-modal-cancel').classList.add('hidden');
                        document.getElementById('modal-confirm').classList.remove('hidden');
                    } else {
                        user = u; localStorage.setItem('podium_user', u); initApp();
                    }
                } else alert('DATOS INCORRECTOS.');
            } catch(e) { alert('ERROR DE CONEXIÓN'); }
            toggleLoader(false);
        }

        async function verEstadísticas(n) {
            toggleLoader(true, "OBTENIENDO STATS...");
            try {
                const r = await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'getStats', region: app.region, nivel: n }) });
                const d = await r.json();
                let txt = d.stats.length > 0 ? d.stats.map(s => `- ${s.nombre}`).join('\n') : "- SIN DATOS -";
                document.getElementById('modal-title').innerText = "ESTADÍSTICAS";
                document.getElementById('modal-text').innerText = "LAS DOS BANDAS MÁS SELECCIONADAS:\n" + txt;
                document.getElementById('btn-modal-ok').innerText = "CERRAR";
                document.getElementById('btn-modal-ok').onclick = closeModal;
                document.getElementById('btn-modal-cancel').classList.add('hidden');
                document.getElementById('modal-confirm').classList.remove('hidden');
            } catch(e) { alert('ERROR'); }
            toggleLoader(false);
        }

        function closeModal() { document.getElementById('modal-confirm').classList.add('hidden'); document.getElementById('btn-modal-cancel').classList.remove('hidden'); }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
